<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis encuesta visitando corazones</title>
    <link rel="icon" type="image/png" href="https://d3dac9gdget83x.cloudfront.net/media/static/images/favicons/logo-verde.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f4; color: #333333; }
        
        :root {
            --clues-green: #0f5319; 
            --clues-gold: #76b82a; 
            --clues-red: #ea047f; 
            --clues-gray: #6F7271;
            --clues-light-gold: #D4C19C;
        }

        .kpi-card { 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
            cursor: pointer;
            border-top-width: 4px;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1); 
        }
        
        .header-border { border-bottom: 4px solid var(--clues-green); }
        .chart-container { height: 380px; position: relative; }

        .modal {
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }

        @keyframes heartPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-heart {
            animation: heartPulse 1.2s ease-in-out infinite;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="status-container" class="flex flex-col items-center justify-center mt-32">
        <div id="loading-animation" class="animate-heart mb-6">
            <i data-lucide="heart" class="w-16 h-16" style="fill: var(--clues-red); color: var(--clues-red);"></i>
        </div>
        <p id="status-text" class="text-xl font-bold uppercase tracking-widest" style="color: var(--clues-green);">Cargando Datos...</p>
        <p id="status-subtext" class="text-sm text-gray-500 mt-2">Visitando corazones para obtener información</p>
        <button id="retry-btn" onclick="location.reload()" class="hidden mt-6 px-8 py-3 bg-gray-800 text-white font-bold uppercase text-xs tracking-widest rounded-lg hover:bg-black transition-colors">Reintentar Conexión</button>
    </div>

    <div id="dashboard-content" class="hidden max-w-7xl mx-auto">
        <header class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0 pb-4 header-border">
                <div class="flex items-center space-x-6">
                    <img src="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/hor-verde.png" alt="Logo CLUES DGIS" class="h-16 w-auto object-contain">
                    <div class="flex flex-col">
                        <div class="text-[9px] sm:text-[11px] font-bold uppercase tracking-tight leading-tight" style="color: var(--clues-gold);">
                            Dirección de Planeación, Evaluación y Proyectos Especiales
                        </div>
                        <div class="text-[9px] sm:text-[11px] font-bold uppercase tracking-tight leading-tight mb-1" style="color: var(--clues-gray);">
                            Subdirección de Informática y Estadísticas en Salud
                        </div>
                        <h1 class="text-xl sm:text-3xl font-extrabold" style="color: var(--clues-green);">
                            Análisis encuesta visitando corazones
                        </h1>
                    </div>
                </div>
            </div>
        </header>

        <section class="mb-12">
            <div class="flex items-center space-x-3 mb-6">
                <i data-lucide="layout-dashboard" class="w-6 h-6 text-gray-400"></i>
                <h2 class="text-xl font-bold uppercase tracking-wide" style="color: var(--clues-gray);">Indicadores Clave</h2>
            </div>
            
            <div id="total-kpi-container" class="mb-8"></div>
            <div id="group-kpi-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center space-x-2 mb-6 border-b pb-2">
                    <div class="w-2 h-6" style="background-color: var(--clues-gold);"></div>
                    <h3 class="text-lg font-bold uppercase" style="color: var(--clues-green);">Distribución por Edad</h3>
                </div>
                <div class="chart-container">
                    <canvas id="ageGroupPieChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center space-x-2 mb-6 border-b pb-2">
                    <div class="w-2 h-6" style="background-color: var(--clues-red);"></div>
                    <h3 class="text-lg font-bold uppercase" style="color: var(--clues-green);">Población por Género</h3>
                </div>
                <div class="chart-container">
                    <canvas id="genderBarChart"></canvas>
                </div>
            </div>
        </section>

        <footer class="mt-16 pt-8 border-t"></footer>
    </div>

    <div id="genderBreakdownModal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="p-6 border-b flex justify-between items-center" style="background-color: var(--clues-green);">
                <h3 id="modalTitle" class="text-xl font-bold text-white uppercase tracking-tight">Desglose</h3>
                <button onclick="hideGenderBreakdown()" class="text-white hover:opacity-75">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-8">
                <div class="space-y-6">
                    <div class="flex justify-between items-end border-b pb-2">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 rounded-full" style="background-color: var(--clues-red);"></div>
                            <span class="text-gray-600 font-medium uppercase text-sm">Femenino</span>
                        </div>
                        <span id="countFemenino" class="text-3xl font-black" style="color: var(--clues-red);">0</span>
                    </div>
                    <div class="flex justify-between items-end border-b pb-2">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 rounded-full" style="background-color: var(--clues-green);"></div>
                            <span class="text-gray-600 font-medium uppercase text-sm">Masculino</span>
                        </div>
                        <span id="countMasculino" class="text-3xl font-black" style="color: var(--clues-green);">0</span>
                    </div>
                    <div id="breakdown-otros" class="text-xs text-right text-gray-400 uppercase hidden">
                        * Otros/Sin especificar: <span id="countOtros">0</span>
                    </div>
                </div>
                <button onclick="hideGenderBreakdown()" class="mt-8 w-full py-3 rounded font-bold uppercase text-sm tracking-widest text-white transition-colors" style="background-color: var(--clues-gold);">
                    Cerrar Detalle
                </button>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1netX0UFy7WUn4MTgF1kBcpsYa46zlQS9_SeS6JFsK9hZNC-Bi9ZR2AFrEExezQe3tv3LX8QAD_a8/pub?output=csv';
        let globalGroupGenderBreakdown = {};

        const COLORS = {
            green: '#0f5319', 
            gold: '#76b82a', 
            red: '#ea047f',
            secondary: '#285C4D',
            gray: '#6F7271'
        };

        const CHART_COLORS = [COLORS.green, COLORS.gold, COLORS.red, COLORS.secondary];
        
        const formatNumber = (num) => {
            return num.toLocaleString('es-MX');
        };

        const getColumnValue = (row, key) => {
            if (row[key] !== undefined) return row[key];
            const capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
            if (row[capitalizedKey] !== undefined) return row[capitalizedKey];
            if (row[key.toUpperCase()] !== undefined) return row[key.toUpperCase()];
            return undefined;
        };
        
        const normalizeGroupKey = (rawGroup) => {
            if (!rawGroup) return 'otro';
            const normalized = String(rawGroup).toLowerCase().trim();
            if (normalized.includes('infanc')) return 'infancia'; 
            if (normalized.includes('adolescen')) return 'adolescentes'; 
            if (normalized.includes('adultos mayor') || normalized.includes('adulto mayor')) return 'adultos mayores';
            if (normalized.includes('adultos') || normalized.includes('adulto')) return 'adultos';
            return normalized;
        };

        const showError = (message) => {
            document.getElementById('loading-animation').classList.add('hidden');
            document.getElementById('status-subtext').classList.add('hidden');
            const statusText = document.getElementById('status-text');
            statusText.textContent = message;
            statusText.style.color = '#dc2626';
            document.getElementById('retry-btn').classList.remove('hidden');
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();

            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: (results) => {
                    if (results.errors.length > 0 && results.data.length === 0) {
                        showError('Error en los datos CSV');
                        return;
                    }
                    if (results.data.length === 0) {
                        showError('Sin registros encontrados');
                        return;
                    }
                    setTimeout(() => {
                        document.getElementById('status-container').classList.add('hidden');
                        document.getElementById('dashboard-content').classList.remove('hidden');
                        processAndRenderData(results.data);
                    }, 800);
                },
                error: (error) => {
                    showError('Error de Conexión');
                }
            });
        });

        function processAndRenderData(data) {
            let totalPoblacion = 0;
            const groupTotals = {};
            const genderTotals = {};
            const groupGenderBreakdown = {};
            const ageGroups = ['infancia', 'adolescentes', 'adultos', 'adultos mayores'];

            data.forEach(row => {
                const countRaw = getColumnValue(row, 'cantidad');
                const count = (countRaw !== undefined && !isNaN(countRaw)) ? countRaw : 1;
                totalPoblacion += count;

                const groupRaw = getColumnValue(row, 'grupo_edad');
                const group = normalizeGroupKey(groupRaw);
                groupTotals[group] = (groupTotals[group] || 0) + count;

                const genderRaw = getColumnValue(row, 'genero');
                const gender = genderRaw ? String(genderRaw).toLowerCase().trim() : 'no especificado';
                genderTotals[gender] = (genderTotals[gender] || 0) + count;
                
                if (!groupGenderBreakdown[group]) groupGenderBreakdown[group] = {};
                groupGenderBreakdown[group][gender] = (groupGenderBreakdown[group][gender] || 0) + count;
            });
            
            globalGroupGenderBreakdown = groupGenderBreakdown;
            renderKPIs(groupTotals, totalPoblacion, ageGroups);
            renderAgeGroupPieChart(groupTotals, ageGroups);
            renderGenderBarChart(genderTotals);
        }

        function showGenderBreakdown(groupKey) {
            const groupData = globalGroupGenderBreakdown[groupKey] || {};
            const displayKey = groupKey.charAt(0).toUpperCase() + groupKey.slice(1);
            const femenino = groupData['femenino'] || 0;
            const masculino = groupData['masculino'] || 0;
            let otros = 0;
            Object.keys(groupData).forEach(key => {
                if (key !== 'femenino' && key !== 'masculino') otros += groupData[key];
            });

            document.getElementById('modalTitle').textContent = `DETALLE: ${displayKey}`;
            document.getElementById('countFemenino').textContent = formatNumber(femenino);
            document.getElementById('countMasculino').textContent = formatNumber(masculino);
            document.getElementById('countOtros').textContent = formatNumber(otros);

            if (otros > 0) document.getElementById('breakdown-otros').classList.remove('hidden');
            else document.getElementById('breakdown-otros').classList.add('hidden');

            document.getElementById('genderBreakdownModal').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function hideGenderBreakdown() {
            document.getElementById('genderBreakdownModal').classList.add('hidden');
        }

        function renderKPIs(groupTotals, totalPoblacion, ageGroups) {
            const totalKpiContainer = document.getElementById('total-kpi-container');
            const groupKpiContainer = document.getElementById('group-kpi-container');
            
            totalKpiContainer.innerHTML = `
                <div class="kpi-card bg-white p-8 rounded-lg shadow-sm border-l-8" style="border-color: var(--clues-green);">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <i data-lucide="activity" class="w-10 h-10" style="color: var(--clues-green);"></i>
                            <h3 class="text-sm font-black uppercase tracking-widest text-gray-500">Población Total Encuestada</h3>
                        </div>
                        <span class="text-5xl font-black text-gray-900">${formatNumber(totalPoblacion)}</span>
                    </div>
                </div>
            `;

            let groupKpiHtml = '';
            const groupDetails = {
                'infancia': { color: COLORS.green, icon: 'baby' },
                'adolescentes': { color: COLORS.gold, icon: 'graduation-cap' },
                'adultos': { color: COLORS.red, icon: 'briefcase' },
                'adultos mayores': { color: COLORS.secondary, icon: 'heart-pulse' }
            };

            ageGroups.forEach(groupKey => {
                const total = groupTotals[groupKey] || 0;
                const percentage = totalPoblacion > 0 ? ((total / totalPoblacion) * 100).toFixed(1) : 0;
                const displayKey = groupKey.charAt(0).toUpperCase() + groupKey.slice(1);
                const details = groupDetails[groupKey] || { color: '#666', icon: 'users' };

                groupKpiHtml += `
                    <div class="kpi-card bg-white p-6 rounded-lg shadow-sm" style="border-top-color: ${details.color};" onclick="showGenderBreakdown('${groupKey}')">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">${displayKey}</span>
                            <i data-lucide="${details.icon}" class="w-5 h-5" style="color: ${details.color};"></i>
                        </div>
                        <div class="text-3xl font-black text-gray-800">${formatNumber(total)}</div>
                        <div class="mt-2 text-xs font-bold px-2 py-1 rounded inline-block" style="background-color: ${details.color}20; color: ${details.color};">
                            ${percentage}% DEL TOTAL
                        </div>
                    </div>
                `;
            });
            
            groupKpiContainer.innerHTML = groupKpiHtml;
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        }

        function renderAgeGroupPieChart(groupTotals, ageGroups) {
            const labels = ageGroups.map(g => g.toUpperCase());
            const dataValues = ageGroups.map(g => groupTotals[g] || 0);

            if (window.ageGroupPieChartInstance) window.ageGroupPieChartInstance.destroy();

            window.ageGroupPieChartInstance = new Chart(document.getElementById('ageGroupPieChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: CHART_COLORS,
                        hoverOffset: 15,
                        borderWidth: 4,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, font: { weight: 'bold', size: 11 } } }
                    }
                }
            });
        }

        function renderGenderBarChart(genderTotals) {
            const labels = Object.keys(genderTotals).map(g => g.toUpperCase());
            const dataValues = Object.values(genderTotals);
            const barColors = labels.map(l => l.includes('FEM') ? COLORS.red : COLORS.green);

            if (window.genderBarChartInstance) window.genderBarChartInstance.destroy();

            window.genderBarChartInstance = new Chart(document.getElementById('genderBarChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: barColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false }, ticks: { font: { weight: 'bold' } } }
                    }
                }
            });
        }
    </script>
</body>
</html>
